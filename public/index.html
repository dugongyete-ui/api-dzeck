<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="/static/img/favicon(Nicoladipa).png" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11"></script>
    <title>Api Dzeck Ai</title>
    <style>
        :root {
            --bg: #212121;
            --sidebar-bg: #171717;
            --sidebar-hover: #2a2a2a;
            --sidebar-active: #343434;
            --msg-ai-bg: #2b2b2b;
            --msg-user-bg: #034953;
            --accent: #00a896;
            --accent-light: #00a896;
            --text: #ececec;
            --text-secondary: #aaa;
            --border: #2a2a2a;
            --code-bg: #1e1e2e;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { height: 100%; -webkit-text-size-adjust: 100%; }
        body { height: 100%; display: flex; font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); overflow: hidden; color: #ececec; }

        .sidebar {
            width: 260px; min-width: 260px; background: var(--sidebar-bg);
            display: flex; flex-direction: column; height: 100vh; transition: transform 0.3s ease;
        }
        .sidebar-header { padding: 14px 12px; }
        .new-chat-btn {
            width: 100%; padding: 10px 14px; background: transparent; color: #fff; border: 1px solid #555;
            border-radius: 10px; font-size: 14px; font-weight: 500; cursor: pointer;
            font-family: 'Inter', sans-serif; transition: all 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .new-chat-btn:hover { background: var(--sidebar-hover); border-color: #888; }
        .new-chat-btn svg { flex-shrink: 0; }
        .convo-list { flex: 1; overflow-y: auto; padding: 4px 8px; }
        .convo-list::-webkit-scrollbar { width: 4px; }
        .convo-list::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        .convo-item {
            padding: 10px 12px; border-radius: 8px; cursor: pointer; margin-bottom: 1px;
            display: flex; align-items: center; justify-content: space-between;
            transition: background 0.15s; color: #ccc; font-size: 13px;
        }
        .convo-item:hover { background: var(--sidebar-hover); }
        .convo-item.active { background: var(--sidebar-active); color: #fff; }
        .convo-title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .convo-time { font-size: 10px; color: #777; white-space: nowrap; margin-left: 6px; }
        .convo-delete { display: none; background: none; border: none; color: #ef4444; font-size: 16px; cursor: pointer; padding: 0 4px; }
        .convo-item:hover .convo-delete { display: block; }
        .convo-item:hover .convo-time { display: none; }
        .sidebar-footer { padding: 10px 12px; border-top: 1px solid #333; }
        .delete-all-btn {
            width: 100%; padding: 8px; background: none; border: 1px solid #555; color: #999;
            border-radius: 8px; font-size: 12px; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.2s;
        }
        .delete-all-btn:hover { border-color: #ef4444; color: #ef4444; }
        .no-convos { text-align: center; padding: 20px 10px; color: #666; font-size: 13px; }

        .main-area { flex: 1; display: flex; flex-direction: column; height: 100vh; height: 100dvh; background: var(--bg); overflow: hidden; position: relative; }

        .header-bar {
            display: flex; align-items: center; padding: 8px 16px; gap: 8px;
            border-bottom: 1px solid #2a2a2a; background: #171717; flex-shrink: 0; min-height: 48px; z-index: 10;
        }
        .menu-toggle { display: none; background: none; border: none; cursor: pointer; padding: 6px; color: var(--accent); font-size: 20px; border-radius: 6px; }
        .menu-toggle:active { background: rgba(255,255,255,0.08); }
        .header-bar img.logo { width: 28px; height: 28px; }
        .brand-name { display: flex; align-items: baseline; gap: 0; flex-shrink: 0; }
        .brand-name .brand-api { font-family: 'Space Grotesk', sans-serif; font-size: 9px; font-weight: 500; color: #00a896; letter-spacing: 1.2px; text-transform: uppercase; margin-right: 3px; }
        .brand-name .brand-dzeck { font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 700; background: linear-gradient(135deg, #00a896, #00c9b7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .brand-name .brand-ai { font-family: 'Space Grotesk', sans-serif; font-size: 18px; font-weight: 600; color: #00a896; margin-left: 2px; }
        .model-badge { font-size: 10px; padding: 2px 8px; background: rgba(0,168,150,0.15); color: var(--accent); border-radius: 12px; white-space: nowrap; font-weight: 500; }
        .nav-links { margin-left: auto; display: flex; gap: 2px; align-items: center; }
        .nav-links a { color: #aaa; text-decoration: none; font-size: 12px; font-weight: 500; padding: 5px 8px; border-radius: 6px; transition: all 0.2s; white-space: nowrap; cursor: pointer; }
        .nav-links a:hover { background: rgba(255,255,255,0.08); color: #ececec; }
        .nav-links span { font-size: 12px; font-weight: 600; color: var(--accent); }

        .chat-area { flex: 1; display: flex; flex-direction: column; width: 100%; overflow: hidden; }
        .messages { flex: 1; overflow-y: auto; scroll-behavior: smooth; }
        .messages::-webkit-scrollbar { width: 6px; }
        .messages::-webkit-scrollbar-thumb { background: #444; border-radius: 6px; }

        .message { padding: 20px 0; animation: msgIn 0.3s ease; }
        .message:last-child { padding-bottom: 24px; }
        .msg-inner { max-width: 768px; margin: 0 auto; padding: 0 24px; display: flex; gap: 16px; align-items: flex-start; }
        .msg-avatar {
            width: 32px; height: 32px; border-radius: 8px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; margin-top: 2px;
        }
        .message-user .msg-avatar { background: var(--msg-user-bg); color: #fff; }
        .message-ai .msg-avatar { background: linear-gradient(135deg, #00a896, #00c9b7); color: #fff; }
        .msg-body { flex: 1; min-width: 0; }
        .msg-sender { font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
        .msg-content { font-size: 15px; line-height: 1.7; color: var(--text); word-wrap: break-word; }
        .msg-content p { margin: 6px 0; }
        .msg-content ul, .msg-content ol { margin: 6px 0 6px 20px; }
        .msg-content li { margin: 3px 0; }
        .msg-content h1 { font-size: 20px; margin: 16px 0 8px; font-weight: 700; }
        .msg-content h2 { font-size: 18px; margin: 14px 0 6px; font-weight: 600; }
        .msg-content h3 { font-size: 16px; margin: 12px 0 4px; font-weight: 600; }
        .msg-content blockquote { border-left: 3px solid #00a896; padding: 6px 12px; margin: 8px 0; background: rgba(0,168,150,0.08); border-radius: 0 6px 6px 0; color: #aaa; }
        .msg-content strong { font-weight: 600; }
        .msg-content a { color: #00c9b7; text-decoration: underline; }
        .msg-content > *:first-child { margin-top: 0; }

        .code-block-wrapper { position: relative; margin: 12px 0; border-radius: 10px; overflow: hidden; border: 1px solid #333; }
        .code-block-header {
            display: flex; align-items: center; justify-content: space-between; padding: 6px 12px;
            background: #2d2d3f; color: #a0a0b8; font-size: 12px; font-family: 'JetBrains Mono', monospace;
        }
        .code-copy-btn {
            background: none; border: 1px solid #555; color: #ccc; padding: 3px 10px; border-radius: 5px;
            font-size: 11px; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.2s;
            display: flex; align-items: center; gap: 4px;
        }
        .code-copy-btn:hover { background: #444; border-color: #888; color: #fff; }
        .code-copy-btn.copied { background: #166534; border-color: #22c55e; color: #22c55e; }
        .msg-content pre { margin: 0; padding: 14px 16px; background: var(--code-bg); overflow-x: auto; font-size: 13px; line-height: 1.5; }
        .msg-content pre code { font-family: 'JetBrains Mono', monospace; background: none; padding: 0; font-size: 13px; color: #cdd6f4; }
        .msg-content code { font-family: 'JetBrains Mono', monospace; background: rgba(255,255,255,0.08); padding: 2px 6px; border-radius: 4px; font-size: 13px; }

        .msg-actions { display: flex; gap: 4px; margin-top: 8px; opacity: 0; transition: opacity 0.2s; }
        .message:hover .msg-actions { opacity: 1; }
        .msg-action-btn {
            background: none; border: 1px solid #444; color: #888; padding: 4px 10px; border-radius: 6px;
            font-size: 12px; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.15s;
            display: flex; align-items: center; gap: 4px;
        }
        .msg-action-btn:hover { background: rgba(255,255,255,0.05); border-color: #666; }
        .msg-action-btn.copied { border-color: #22c55e; color: #16a34a; }

        .image-in-msg { max-width: 280px; max-height: 200px; border-radius: 10px; margin-top: 8px; border: 1px solid #444; }

        .input-section {
            padding: 0 16px 16px; padding-bottom: calc(16px + var(--safe-bottom));
            background: var(--bg); flex-shrink: 0; position: relative;
        }
        .input-container { max-width: 768px; margin: 0 auto; }
        #image-preview-container { margin-bottom: 8px; }
        .selected-image-preview {
            display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px;
            background: #2f2f2f; border: 1px solid #444; border-radius: 10px;
        }
        .selected-image-preview img { max-height: 48px; border-radius: 6px; }
        .selected-image-preview .img-name { font-size: 12px; color: #aaa; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .selected-image-preview .remove-img { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 18px; padding: 0 2px; line-height: 1; }
        .input-box {
            display: flex; align-items: flex-end; gap: 0; background: #2f2f2f; border-radius: 20px;
            border: 1px solid #444; padding: 8px 8px 8px 4px; transition: all 0.2s;
        }
        .input-box:focus-within { border-color: #00a896; box-shadow: 0 0 0 2px rgba(0,168,150,0.2); }
        .input-tools { display: flex; align-items: center; flex-shrink: 0; }
        .tool-btn {
            background: none; border: none; color: #aaa; cursor: pointer; padding: 8px;
            border-radius: 8px; transition: all 0.15s; display: flex; align-items: center; justify-content: center;
        }
        .tool-btn:hover { color: #00a896; background: rgba(0,168,150,0.15); }
        .tool-btn:active { transform: scale(0.92); }
        #chat-input {
            flex: 1; border: none; outline: none; font-family: 'Inter', sans-serif; font-size: 15px;
            background: transparent; resize: none; max-height: 160px; min-height: 24px; line-height: 24px;
            padding: 4px 8px; color: var(--text);
        }
        #chat-input::placeholder { color: #777; }
        #send-btn {
            background: var(--accent); color: white; border: none; border-radius: 12px;
            width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center;
            justify-content: center; transition: all 0.15s; flex-shrink: 0;
        }
        #send-btn:hover { opacity: 0.85; transform: scale(1.04); }
        #send-btn:active { transform: scale(0.94); }
        #send-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
        .input-hint { text-align: center; font-size: 11px; color: #666; margin-top: 6px; }

        .typing-indicator { display: flex; gap: 5px; padding: 4px 0; }
        .typing-dot { width: 8px; height: 8px; background: var(--accent-light); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        .welcome-section { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 32px 24px; }
        .welcome-logo { font-family: 'Space Grotesk', sans-serif; font-size: 36px; font-weight: 700; background: linear-gradient(135deg, #00a896, #00c9b7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
        .welcome-sub { color: #888; font-size: 15px; margin-bottom: 28px; text-align: center; }
        .suggestion-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 500px; width: 100%; }
        .suggestion-card {
            padding: 14px 16px; background: #2f2f2f; border: 1px solid #444; border-radius: 12px;
            cursor: pointer; transition: all 0.2s; text-align: left;
        }
        .suggestion-card:hover { border-color: #00a896; box-shadow: none; }
        .suggestion-card:active { transform: scale(0.97); }
        .suggestion-title { font-size: 13px; font-weight: 600; color: #ececec; margin-bottom: 2px; }
        .suggestion-desc { font-size: 12px; color: #888; }

        .search-card {
            background: #2b2b2b; border: 1px solid #333; border-radius: 12px; padding: 12px 16px;
            margin: 10px 0; display: flex; align-items: center; gap: 10px;
        }
        .search-card-icon { width: 32px; height: 32px; background: linear-gradient(135deg, #00a896, #00c9b7); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .search-card-icon svg { color: #fff; }
        .search-card-text { flex: 1; }
        .search-card-label { font-size: 12px; color: #888; font-weight: 500; }
        .search-card-query { font-size: 14px; color: #ececec; font-weight: 600; }
        .search-dots { display: flex; gap: 3px; }
        .search-dots span { width: 4px; height: 4px; background: var(--accent-light); border-radius: 50%; animation: bounce 1s infinite; }
        .search-dots span:nth-child(2) { animation-delay: 0.15s; }
        .search-dots span:nth-child(3) { animation-delay: 0.3s; }

        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
        .login-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
        .login-overlay.open { display: flex; }
        .login-box { background: #2b2b2b; border-radius: 16px; padding: 32px; width: 380px; max-width: 92%; box-shadow: 0 20px 60px rgba(0,0,0,0.2); position: relative; }
        .login-box h2 { color: #00a896; font-size: 22px; margin-bottom: 20px; text-align: center; font-family: 'Space Grotesk', sans-serif; }
        .login-box input { width: 100%; padding: 12px 14px; border: 1px solid #444; border-radius: 10px; font-size: 14px; font-family: 'Inter', sans-serif; margin-bottom: 12px; outline: none; transition: border 0.2s; background: #2f2f2f; color: #ececec; }
        .login-box input:focus { border-color: #00a896; }
        .login-box .login-submit { width: 100%; padding: 12px; background: #00a896; color: #fff; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .login-box .login-submit:hover { opacity: 0.9; }
        .login-error { color: #ef4444; font-size: 13px; text-align: center; margin-bottom: 10px; display: none; }
        .login-close { position: absolute; top: 12px; right: 14px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }

        @keyframes msgIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: 0; top: 0; z-index: 100; transform: translateX(-100%); width: 280px; }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay.open { display: block; }
            .menu-toggle { display: flex; }
            .header-bar { padding: 6px 10px; }
            .brand-name .brand-dzeck, .brand-name .brand-ai { font-size: 16px; }
            .brand-name .brand-api { font-size: 8px; }
            .header-bar img.logo { width: 24px; height: 24px; }
            .nav-links a { font-size: 11px; padding: 4px 6px; }
            .msg-inner { padding: 0 14px; gap: 10px; }
            .msg-avatar { width: 28px; height: 28px; font-size: 12px; }
            .msg-content { font-size: 14px; }
            .message { padding: 14px 0; }
            .input-section { padding: 0 10px 12px; padding-bottom: calc(12px + var(--safe-bottom)); }
            .suggestion-grid { grid-template-columns: 1fr; }
            .welcome-logo { font-size: 28px; }
            .msg-actions { opacity: 1; }
            .message:hover .msg-actions { opacity: 1; }
        }
        @media (max-width: 400px) {
            .header-bar { gap: 4px; }
            .brand-name .brand-dzeck, .brand-name .brand-ai { font-size: 14px; }
            .nav-links a { font-size: 10px; padding: 3px 4px; }
            .nav-links { gap: 0; }
            .model-badge { font-size: 8px; padding: 2px 5px; }
            .msg-content { font-size: 13px; }
            .input-section { padding: 0 6px 10px; padding-bottom: calc(10px + var(--safe-bottom)); }
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="createNewChat()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                New Chat
            </button>
        </div>
        <div class="convo-list" id="convo-list">
            <div class="no-convos" id="no-convos">Belum ada percakapan</div>
        </div>
        <div class="sidebar-footer">
            <button class="delete-all-btn" onclick="deleteAllConversations()">Hapus Semua Chat</button>
        </div>
    </aside>

    <div class="main-area">
        <div class="header-bar">
            <button class="menu-toggle" onclick="toggleSidebar()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            </button>
            <img class="logo" src="/static/img/favicon(Nicoladipa).png" alt="Logo">
            <div class="brand-name">
                <span class="brand-api">API</span>
                <span class="brand-dzeck">Dzeck</span>
                <span class="brand-ai">Ai</span>
            </div>
            <span class="model-badge" id="model-badge">loading...</span>
            <div class="nav-links">
                <a href="/settings.html">Settings</a>
                <a href="/models.html">Models</a>
                <span id="user-display" style="display:none;"></span>
                <a id="login-link" onclick="showLogin()">Login</a>
                <a id="logout-link" onclick="doLogout()" style="display:none;color:#ef4444;">Logout</a>
            </div>
        </div>

        <div class="chat-area">
            <div class="messages" id="messages">
                <div id="welcome" class="welcome-section">
                    <div class="welcome-logo">Dzeck Ai</div>
                    <p class="welcome-sub">Akses gratis ke berbagai model AI. Mulai percakapan sekarang.</p>
                    <div class="suggestion-grid">
                        <div class="suggestion-card" onclick="askQuestion('Jelaskan quantum computing secara sederhana')">
                            <div class="suggestion-title">Quantum Computing</div>
                            <div class="suggestion-desc">Jelaskan secara sederhana</div>
                        </div>
                        <div class="suggestion-card" onclick="askQuestion('Buatkan kode Python hello world dengan penjelasan')">
                            <div class="suggestion-title">Python Code</div>
                            <div class="suggestion-desc">Hello world + penjelasan</div>
                        </div>
                        <div class="suggestion-card" onclick="askQuestion('Apa itu machine learning dan contohnya?')">
                            <div class="suggestion-title">Machine Learning</div>
                            <div class="suggestion-desc">Penjelasan dan contoh</div>
                        </div>
                        <div class="suggestion-card" onclick="askQuestion('Carikan informasi terbaru tentang harga Bitcoin')">
                            <div class="suggestion-title">Harga Bitcoin</div>
                            <div class="suggestion-desc">Info terbaru crypto</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-section">
                <div class="input-container">
                    <div id="image-preview-container" style="display:none;"></div>
                    <div class="input-box">
                        <div class="input-tools">
                            <button class="tool-btn" onclick="document.getElementById('image-input').click()" title="Upload foto">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
                            </button>
                            <input type="file" id="image-input" accept="image/*" style="display:none" onchange="handleImageSelect(event)">
                        </div>
                        <textarea id="chat-input" rows="1" placeholder="Tulis pesan..." onkeydown="handleKeyDown(event)"></textarea>
                        <button id="send-btn" onclick="sendMessage()" title="Kirim">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </button>
                    </div>
                    <div class="input-hint">Dzeck Ai bisa membuat kesalahan. Periksa informasi penting.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="login-overlay" id="login-overlay">
        <div class="login-box">
            <button class="login-close" onclick="hideLogin()">&times;</button>
            <h2>Login</h2>
            <p class="login-error" id="login-error"></p>
            <input type="text" id="login-username" placeholder="Username" autocomplete="username">
            <input type="password" id="login-password" placeholder="Password" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
            <button class="login-submit" onclick="doLogin()">Login</button>
        </div>
    </div>

    <script src="/api-config.js"></script>
    <script>
        const messagesDiv = document.getElementById('messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const modelBadge = document.getElementById('model-badge');
        const convoList = document.getElementById('convo-list');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const noConvos = document.getElementById('no-convos');
        let isLoading = false;
        let currentConvoId = null;
        let conversationMessages = [];
        let currentUser = null;
        let selectedImageBase64 = null;

        if (typeof marked !== 'undefined') {
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        try { return hljs.highlight(code, {language: lang}).value; } catch(e) {}
                    }
                    try { return hljs.highlightAuto(code).value; } catch(e) {}
                    return code;
                },
                breaks: true,
                gfm: true
            });
        }

        function toggleSidebar() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('open');
        }

        function showLogin() { document.getElementById('login-overlay').classList.add('open'); document.getElementById('login-username').focus(); }
        function hideLogin() { document.getElementById('login-overlay').classList.remove('open'); document.getElementById('login-error').style.display = 'none'; }

        async function doLogin() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const errorEl = document.getElementById('login-error');
            if (!username || !password) { errorEl.textContent = 'Masukkan username dan password'; errorEl.style.display = 'block'; return; }
            try {
                const res = await apiFetch('/api/auth/login', { method: 'POST', body: JSON.stringify({ username, password }) });
                const data = await res.json();
                if (data.success) { currentUser = data.username; updateUserUI(); hideLogin(); await loadConversations(); }
                else { errorEl.textContent = data.error || 'Login gagal'; errorEl.style.display = 'block'; }
            } catch (e) { errorEl.textContent = 'Tidak bisa terhubung ke server'; errorEl.style.display = 'block'; }
        }

        async function doLogout() {
            try { await apiFetch('/api/auth/logout'); } catch(e) {}
            currentUser = null; updateUserUI(); currentConvoId = null; conversationMessages = []; showWelcome(); await loadConversations();
        }

        function updateUserUI() {
            const ud = document.getElementById('user-display');
            const ll = document.getElementById('login-link');
            const lo = document.getElementById('logout-link');
            if (currentUser) { ud.textContent = currentUser; ud.style.display = 'inline'; ll.style.display = 'none'; lo.style.display = 'inline'; }
            else { ud.style.display = 'none'; ll.style.display = 'inline'; lo.style.display = 'none'; }
        }

        async function checkSession() {
            try {
                const res = await apiFetch('/api/auth/check');
                if (res.ok) { const data = await res.json(); if (data.logged_in) { currentUser = data.username; updateUserUI(); } }
            } catch(e) {}
        }

        function timeAgo(ts) {
            const diff = (Date.now() / 1000) - ts;
            if (diff < 60) return 'baru saja';
            if (diff < 3600) return Math.floor(diff / 60) + 'm';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h';
            return Math.floor(diff / 86400) + 'd';
        }

        async function loadConversations() {
            try {
                const res = await apiFetch('/api/conversations');
                if (res.ok) { const data = await res.json(); renderConvoList(data.conversations || []); }
            } catch(e) {}
        }

        function renderConvoList(convos) {
            const existing = convoList.querySelectorAll('.convo-item');
            existing.forEach(el => el.remove());
            if (convos.length === 0) { noConvos.style.display = 'block'; return; }
            noConvos.style.display = 'none';
            for (const c of convos) {
                const div = document.createElement('div');
                div.className = 'convo-item' + (c.id === currentConvoId ? ' active' : '');
                div.dataset.id = c.id;
                div.onclick = (e) => { if (!e.target.classList.contains('convo-delete')) loadConversation(c.id); };
                div.innerHTML = '<span class="convo-title">' + escapeHtml(c.title || 'New Chat') + '</span><span class="convo-time">' + timeAgo(c.updated_at) + '</span><button class="convo-delete" onclick="event.stopPropagation();deleteConversation(\'' + c.id + '\')">&times;</button>';
                convoList.appendChild(div);
            }
        }

        function escapeHtml(str) { const d = document.createElement('div'); d.textContent = str; return d.innerHTML; }

        async function createNewChat() {
            try {
                const res = await apiFetch('/api/conversations', { method: 'POST', body: JSON.stringify({title: 'New Chat'}) });
                if (res.ok) { const convo = await res.json(); currentConvoId = convo.id; conversationMessages = []; showWelcome(); await loadConversations(); if (window.innerWidth < 768) toggleSidebar(); }
            } catch(e) {}
        }

        async function loadConversation(convoId) {
            try {
                const res = await apiFetch('/api/conversations/' + convoId);
                if (res.ok) {
                    const convo = await res.json();
                    currentConvoId = convo.id;
                    let msgs = convo.messages;
                    if (typeof msgs === 'string') { try { msgs = JSON.parse(msgs); } catch(e) { msgs = []; } }
                    conversationMessages = msgs || [];
                    messagesDiv.innerHTML = '';
                    if (conversationMessages.length === 0) { showWelcome(); }
                    else { for (const msg of conversationMessages) { addMessageUI(msg.content, msg.role === 'user', null); } }
                    document.querySelectorAll('.convo-item').forEach(el => { el.classList.toggle('active', el.dataset.id === convoId); });
                    if (window.innerWidth < 768) toggleSidebar();
                }
            } catch(e) {}
        }

        async function saveCurrentConvo() {
            if (!currentConvoId) return;
            let title;
            if (conversationMessages.length > 0) {
                const firstUser = conversationMessages.find(m => m.role === 'user');
                if (firstUser) { title = firstUser.content.substring(0, 30); if (firstUser.content.length > 30) title += '...'; }
            }
            try {
                const saveMsgs = conversationMessages.map(m => {
                    const clean = {role: m.role, content: m.content, timestamp: m.timestamp};
                    if (m.image || m.hasImage) clean.hasImage = true;
                    return clean;
                });
                await apiFetch('/api/conversations/' + currentConvoId, { method: 'PUT', body: JSON.stringify({messages: saveMsgs, title: title}) });
                await loadConversations();
            } catch(e) {}
        }

        async function deleteConversation(convoId) {
            try { await apiFetch('/api/conversations/' + convoId, {method: 'DELETE'}); if (currentConvoId === convoId) { currentConvoId = null; conversationMessages = []; showWelcome(); } await loadConversations(); } catch(e) {}
        }

        async function deleteAllConversations() {
            if (!confirm('Hapus semua percakapan?')) return;
            try { await apiFetch('/api/conversations/all', {method: 'DELETE'}); currentConvoId = null; conversationMessages = []; showWelcome(); await loadConversations(); } catch(e) {}
        }

        function showWelcome() {
            messagesDiv.innerHTML = '';
            const w = document.createElement('div');
            w.id = 'welcome';
            w.className = 'welcome-section';
            w.innerHTML = '<div class="welcome-logo">Dzeck Ai</div><p class="welcome-sub">Akses gratis ke berbagai model AI. Mulai percakapan sekarang.</p><div class="suggestion-grid"><div class="suggestion-card" onclick="askQuestion(\'Jelaskan quantum computing secara sederhana\')"><div class="suggestion-title">Quantum Computing</div><div class="suggestion-desc">Jelaskan secara sederhana</div></div><div class="suggestion-card" onclick="askQuestion(\'Buatkan kode Python hello world dengan penjelasan\')"><div class="suggestion-title">Python Code</div><div class="suggestion-desc">Hello world + penjelasan</div></div><div class="suggestion-card" onclick="askQuestion(\'Apa itu machine learning dan contohnya?\')"><div class="suggestion-title">Machine Learning</div><div class="suggestion-desc">Penjelasan dan contoh</div></div><div class="suggestion-card" onclick="askQuestion(\'Carikan informasi terbaru tentang harga Bitcoin\')"><div class="suggestion-title">Harga Bitcoin</div><div class="suggestion-desc">Info terbaru crypto</div></div></div>';
            messagesDiv.appendChild(w);
        }

        async function loadChatSettings() {
            try {
                const res = await apiFetch('/api/chat-settings');
                if (res.ok) { const data = await res.json(); modelBadge.textContent = data.model + ' (' + data.provider + ')'; }
            } catch(e) { modelBadge.textContent = ''; }
        }

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) { alert('Ukuran gambar maksimal 5MB'); event.target.value = ''; return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedImageBase64 = e.target.result;
                const container = document.getElementById('image-preview-container');
                container.style.display = 'block';
                container.innerHTML = '<div class="selected-image-preview"><img src="' + selectedImageBase64 + '" alt="preview"><span class="img-name">' + escapeHtml(file.name) + '</span><button class="remove-img" onclick="removeSelectedImage()">&times;</button></div>';
            };
            reader.readAsDataURL(file);
        }

        function removeSelectedImage() {
            selectedImageBase64 = null;
            const c = document.getElementById('image-preview-container');
            c.style.display = 'none'; c.innerHTML = '';
            document.getElementById('image-input').value = '';
        }

        chatInput.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 160) + 'px'; });
        function handleKeyDown(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
        function askQuestion(text) { chatInput.value = text; sendMessage(); }

        function renderMarkdown(text) {
            if (typeof marked !== 'undefined' && marked.parse) {
                try { return marked.parse(text); } catch(e) {}
            }
            return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
        }

        function addCodeCopyButtons(container) {
            const pres = container.querySelectorAll('pre');
            pres.forEach(function(pre) {
                if (pre.parentElement.classList.contains('code-block-wrapper')) return;
                const code = pre.querySelector('code');
                let lang = '';
                if (code) {
                    const cls = code.className || '';
                    const m = cls.match(/language-(\w+)/);
                    if (m) lang = m[1];
                }
                const wrapper = document.createElement('div');
                wrapper.className = 'code-block-wrapper';
                const header = document.createElement('div');
                header.className = 'code-block-header';
                header.innerHTML = '<span>' + (lang || 'code') + '</span>';
                const copyBtn = document.createElement('button');
                copyBtn.className = 'code-copy-btn';
                copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy';
                copyBtn.onclick = function(ev) {
                    ev.stopPropagation();
                    const codeText = pre.textContent;
                    navigator.clipboard.writeText(codeText).then(function() {
                        copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Copied!';
                        copyBtn.classList.add('copied');
                        setTimeout(function() {
                            copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy';
                            copyBtn.classList.remove('copied');
                        }, 2000);
                    });
                };
                header.appendChild(copyBtn);
                pre.parentNode.insertBefore(wrapper, pre);
                wrapper.appendChild(header);
                wrapper.appendChild(pre);
            });
        }

        function addMessageUI(text, isUser, imageData) {
            const welcome = document.getElementById('welcome');
            if (welcome) welcome.remove();
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ' + (isUser ? 'message-user' : 'message-ai');
            const inner = document.createElement('div');
            inner.className = 'msg-inner';

            const avatar = document.createElement('div');
            avatar.className = 'msg-avatar';
            avatar.textContent = isUser ? (currentUser ? currentUser[0].toUpperCase() : 'U') : 'D';
            inner.appendChild(avatar);

            const body = document.createElement('div');
            body.className = 'msg-body';

            const sender = document.createElement('div');
            sender.className = 'msg-sender';
            sender.textContent = isUser ? (currentUser || 'You') : 'Dzeck Ai';
            body.appendChild(sender);

            const content = document.createElement('div');
            content.className = 'msg-content';

            if (isUser) {
                if (imageData) {
                    const img = document.createElement('img');
                    img.src = imageData;
                    img.className = 'image-in-msg';
                    content.appendChild(img);
                }
                const p = document.createElement('p');
                p.textContent = text || '';
                content.appendChild(p);
            } else {
                if (text) {
                    content.innerHTML = renderMarkdown(text);
                    addCodeCopyButtons(content);
                }
            }
            body.appendChild(content);

            if (!isUser) {
                const actions = document.createElement('div');
                actions.className = 'msg-actions';
                const copyAll = document.createElement('button');
                copyAll.className = 'msg-action-btn';
                copyAll.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy All';
                copyAll.onclick = function() {
                    navigator.clipboard.writeText(content.textContent).then(function() {
                        copyAll.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Copied!';
                        copyAll.classList.add('copied');
                        setTimeout(function() {
                            copyAll.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy All';
                            copyAll.classList.remove('copied');
                        }, 2000);
                    });
                };
                actions.appendChild(copyAll);
                body.appendChild(actions);
            }

            inner.appendChild(body);
            msgDiv.appendChild(inner);
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return content;
        }

        function showSearchCard(query) {
            const welcome = document.getElementById('welcome');
            if (welcome) welcome.remove();
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message message-ai';
            msgDiv.id = 'search-card';
            const inner = document.createElement('div');
            inner.className = 'msg-inner';
            const avatar = document.createElement('div');
            avatar.className = 'msg-avatar';
            avatar.textContent = 'D';
            inner.appendChild(avatar);
            const body = document.createElement('div');
            body.className = 'msg-body';
            body.innerHTML = '<div class="search-card"><div class="search-card-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div><div class="search-card-text"><div class="search-card-label">Mencari informasi...</div><div class="search-card-query">' + escapeHtml(query) + '</div></div><div class="search-dots"><span></span><span></span><span></span></div></div>';
            inner.appendChild(body);
            msgDiv.appendChild(inner);
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function removeSearchCard() { const s = document.getElementById('search-card'); if (s) s.remove(); }

        function showTyping() {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message message-ai'; msgDiv.id = 'typing';
            const inner = document.createElement('div');
            inner.className = 'msg-inner';
            const avatar = document.createElement('div');
            avatar.className = 'msg-avatar';
            avatar.textContent = 'D';
            inner.appendChild(avatar);
            const body = document.createElement('div');
            body.className = 'msg-body';
            body.innerHTML = '<div class="msg-sender">Dzeck Ai</div><div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
            inner.appendChild(body);
            msgDiv.appendChild(inner);
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        function removeTyping() { const t = document.getElementById('typing'); if (t) t.remove(); }

        function isSearchQuery(text) {
            const searchKeywords = ['cari', 'carikan', 'search', 'find', 'harga', 'price', 'berita', 'news', 'terbaru', 'latest', 'sekarang', 'cuaca', 'weather', 'kurs', 'skor', 'score', 'jadwal', 'update'];
            const lower = text.toLowerCase();
            return searchKeywords.some(k => lower.includes(k));
        }

        function buildContextMessage(newMessage) {
            if (conversationMessages.length === 0) return newMessage;
            let context = "[CONVERSATION HISTORY]\n";
            const historySlice = conversationMessages;
            for (const msg of historySlice) {
                let msgText = msg.content || '';
                if (msg.image || msg.hasImage) msgText += ' [Image attached]';
                if (msg.role === "user") context += "User: " + msgText + "\n";
                else if (msg.role === "assistant") context += "Assistant: " + msgText + "\n";
            }
            context += "[END HISTORY]\n\nUser: " + newMessage;
            return context;
        }

        async function sendMessage() {
            if (isLoading) return;
            const text = chatInput.value.trim();
            if (!text && !selectedImageBase64) return;
            if (!currentConvoId) await createNewChat();
            isLoading = true; sendBtn.disabled = true;
            chatInput.value = ''; chatInput.style.height = 'auto';
            const currentImage = selectedImageBase64;
            removeSelectedImage();
            addMessageUI(text || '[Image]', true, currentImage);
            conversationMessages.push({role: 'user', content: text, image: currentImage || undefined, timestamp: Date.now()});

            const isSearch = isSearchQuery(text);
            if (isSearch) { showSearchCard(text); } else { showTyping(); }

            const contextMessage = buildContextMessage(text);
            try {
                const reqBody = {text: contextMessage};
                if (currentImage) reqBody.image = currentImage;
                const res = await fetch(API_BASE + '/stream', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify(reqBody)
                });
                if (!res.ok) throw new Error('Server error');
                removeSearchCard();
                removeTyping();
                const contentEl = addMessageUI('', false);
                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let fullText = ''; let buffer = '';
                let renderTimer = null;
                function doRender() {
                    if (contentEl) {
                        contentEl.innerHTML = renderMarkdown(fullText);
                        addCodeCopyButtons(contentEl);
                    }
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const payload = line.slice(6);
                            if (payload === '[DONE]') continue;
                            try { const chunk = JSON.parse(payload); fullText += chunk; } catch (e) {}
                        }
                    }
                    if (!renderTimer) {
                        renderTimer = setTimeout(function() { doRender(); renderTimer = null; }, 80);
                    }
                }
                if (renderTimer) { clearTimeout(renderTimer); }
                doRender();
                conversationMessages.push({role: 'assistant', content: fullText, timestamp: Date.now()});
                await saveCurrentConvo();
            } catch (err) {
                removeSearchCard();
                removeTyping();
                addMessageUI('Maaf, tidak bisa mendapatkan respons. Silakan coba lagi.', false);
            }
            isLoading = false; sendBtn.disabled = false; chatInput.focus();
        }

        (async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('msg') === 'login_required') {
                const toast = document.createElement('div');
                toast.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9999;background:#b91c1c;color:#fff;padding:12px 24px;border-radius:12px;font-size:14px;font-weight:600;box-shadow:0 4px 16px rgba(0,0,0,0.15);animation:msgIn 0.3s;';
                toast.textContent = 'Silakan login terlebih dahulu';
                document.body.appendChild(toast);
                setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.5s'; setTimeout(() => toast.remove(), 500); }, 3000);
                window.history.replaceState({}, '', '/');
            }
            await checkSession();
            loadChatSettings();
            await loadConversations();
        })();
    </script>
</body>
</html>
