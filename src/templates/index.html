<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11"></script>
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet" type="text/css">
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon(Nicoladipa).png') }}" type="image/x-icon">
    <title>Api Dzeck Ai Web API</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { height: 100%; height: -webkit-fill-available; overflow: hidden; }
        body { display: flex; font-family: 'Inter', sans-serif; height: 100vh; height: 100dvh; height: -webkit-fill-available; overflow: hidden; background: #212121; color: #ececec; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        * { scrollbar-width: thin; scrollbar-color: #444 transparent; }

        .sidebar {
            width: 260px; min-width: 260px; background: #171717; border-right: 1px solid #2a2a2a;
            display: flex; flex-direction: column; height: 100vh; height: 100dvh; transition: transform 0.3s;
        }
        .sidebar-header { padding: 14px 16px; border-bottom: 1px solid #2a2a2a; }
        .new-chat-btn {
            width: 100%; padding: 10px; background: #2f2f2f; color: #ececec; border: 1px solid #444;
            border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;
            font-family: 'Inter', sans-serif; transition: background 0.2s;
        }
        .new-chat-btn:hover { background: #3a3a3a; }
        .convo-list { flex: 1; overflow-y: auto; padding: 8px; }
        .convo-item {
            padding: 10px 12px; border-radius: 8px; cursor: pointer; margin-bottom: 2px;
            display: flex; align-items: center; justify-content: space-between;
            transition: background 0.15s; position: relative;
        }
        .convo-item:hover { background: #2a2a2a; }
        .convo-item.active { background: #2f2f2f; }
        .convo-title { flex: 1; font-size: 13px; color: #d1d1d1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .convo-time { font-size: 10px; color: #777; white-space: nowrap; margin-left: 6px; }
        .convo-delete {
            display: none; background: none; border: none; color: #ef4444; font-size: 16px;
            cursor: pointer; padding: 0 4px; line-height: 1; font-weight: bold;
        }
        .convo-item:hover .convo-delete { display: block; }
        .convo-item:hover .convo-time { display: none; }
        .sidebar-footer { padding: 10px 16px; border-top: 1px solid #2a2a2a; }
        .delete-all-btn {
            width: 100%; padding: 8px; background: none; border: 1px solid #ef4444; color: #ef4444;
            border-radius: 8px; font-size: 12px; cursor: pointer; font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }
        .delete-all-btn:hover { background: #ef4444; color: white; }

        .main-area { flex: 1; display: flex; flex-direction: column; height: 100vh; height: 100dvh; background: #212121; overflow: hidden; min-width: 0; }
        .header-bar {
            display: flex; align-items: center; padding: 10px 16px; gap: 10px;
            border-bottom: 1px solid #2a2a2a; flex-wrap: wrap; background: #171717;
            flex-shrink: 0;
        }
        .menu-toggle {
            display: none; background: none; border: none; cursor: pointer; padding: 4px;
            color: #ececec; font-size: 22px;
        }
        .header-bar img.logo { width: 36px; height: 36px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .brand-name { display: flex; align-items: baseline; gap: 0; flex-shrink: 0; }
        .brand-name .brand-api { font-family: 'Space Grotesk', sans-serif; font-size: 11px; font-weight: 500; color: #00a896; letter-spacing: 1.5px; text-transform: uppercase; margin-right: 4px; }
        .brand-name .brand-dzeck { font-family: 'Space Grotesk', sans-serif; font-size: 22px; font-weight: 700; background: linear-gradient(135deg, #00a896, #00c9b7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: -0.5px; }
        .brand-name .brand-ai { font-family: 'Space Grotesk', sans-serif; font-size: 22px; font-weight: 600; color: #00a896; margin-left: 3px; }
        .model-badge { font-size: 10px; padding: 2px 6px; background: rgba(0,168,150,0.15); color: #00a896; border-radius: 10px; white-space: nowrap; }
        .nav-links { margin-left: auto; display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .nav-links a { color: #aaa; text-decoration: none; font-size: 13px; font-weight: 500; padding: 4px 8px; border-radius: 6px; transition: all 0.2s; white-space: nowrap; }
        .nav-links a:hover { background: rgba(255,255,255,0.08); color: #ececec; }
        .nav-links span { font-size: 13px; }

        .chat-area { flex: 1; display: flex; flex-direction: column; width: 100%; overflow: hidden; min-height: 0; }
        .messages { flex: 1; overflow-y: auto; padding: 0; min-height: 0; -webkit-overflow-scrolling: touch; }

        .message { padding: 20px 16px; animation: fadeIn 0.3s ease; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .message-inner { max-width: 768px; margin: 0 auto; display: flex; gap: 16px; align-items: flex-start; width: 100%; }
        .message-avatar {
            width: 28px; height: 28px; min-width: 28px; border-radius: 4px; display: flex;
            align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px;
        }
        .message-user .message-avatar { background: #00a896; }
        .message-ai .message-avatar { background: #2f2f2f; border: 1px solid #444; }
        .message-avatar svg { width: 16px; height: 16px; }
        .message-content { flex: 1; min-width: 0; line-height: 1.7; font-size: 15px; word-wrap: break-word; }
        .message-content p { margin: 6px 0; }
        .message-content ul, .message-content ol { margin: 6px 0 6px 20px; }
        .message-content li { margin: 3px 0; }
        .message-content h1 { font-size: 20px; margin: 16px 0 8px; font-weight: 700; }
        .message-content h2 { font-size: 18px; margin: 14px 0 6px; font-weight: 600; }
        .message-content h3 { font-size: 16px; margin: 12px 0 4px; font-weight: 600; }
        .message-content h4 { font-size: 15px; margin: 10px 0 4px; font-weight: 600; }
        .message-content blockquote { border-left: 3px solid #00a896; padding: 6px 12px; margin: 8px 0; background: rgba(0,168,150,0.08); border-radius: 0 6px 6px 0; color: #aaa; }
        .message-content strong { font-weight: 600; }
        .message-content a { color: #00c9b7; text-decoration: underline; }
        .message-content > *:first-child { margin-top: 0; }
        .message-content code { font-family: 'JetBrains Mono', monospace; background: rgba(255,255,255,0.08); padding: 2px 6px; border-radius: 4px; font-size: 13px; }
        .message-content pre { margin: 0; padding: 14px 16px; background: #1e1e2e; overflow-x: auto; font-size: 13px; line-height: 1.5; }
        .message-content pre code { font-family: 'JetBrains Mono', monospace; background: none; padding: 0; font-size: 13px; color: #cdd6f4; }
        .message-user { background: transparent; }
        .message-ai { background: #2b2b2b; }
        .message-user .message-content { color: #ececec; white-space: pre-wrap; }
        .message-ai .message-content { color: #d1d1d1; position: relative; }

        .code-block-wrapper { position: relative; margin: 12px 0; border-radius: 10px; overflow: hidden; border: 1px solid #333; }
        .code-block-header {
            display: flex; align-items: center; justify-content: space-between; padding: 6px 12px;
            background: #2d2d3f; color: #a0a0b8; font-size: 12px; font-family: 'JetBrains Mono', monospace;
        }
        .code-copy-btn {
            background: none; border: 1px solid #555; color: #ccc; padding: 3px 10px; border-radius: 5px;
            font-size: 11px; cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.2s;
            display: flex; align-items: center; gap: 4px;
        }
        .code-copy-btn:hover { background: #444; border-color: #888; color: #fff; }
        .code-copy-btn.copied { background: #166534; border-color: #22c55e; color: #22c55e; }

        .copy-btn {
            background: none; border: 1px solid #444; color: #888; font-size: 11px;
            padding: 3px 10px; border-radius: 6px; cursor: pointer; transition: all 0.2s;
            font-family: 'Inter', sans-serif; margin-top: 8px; display: inline-block;
        }
        .copy-btn:hover { background: #00a896; color: white; border-color: #00a896; }
        .copy-btn.copied { background: #27ae60; color: white; border-color: #27ae60; }

        .input-area {
            position: sticky; bottom: 0; flex-shrink: 0; background: #212121;
            padding: 12px 16px;
            padding-bottom: max(16px, env(safe-area-inset-bottom, 16px));
            border-top: 1px solid #2a2a2a;
        }
        .input-wrapper {
            display: flex; gap: 8px; background: #2f2f2f; border-radius: 24px;
            padding: 8px 8px 8px 16px; border: 1px solid #444; transition: border-color 0.2s;
            align-items: flex-end; max-width: 768px; margin: 0 auto;
        }
        .input-wrapper:focus-within { border-color: #00a896; box-shadow: 0 0 0 2px rgba(0,168,150,0.2); }
        #chat-input {
            flex: 1; border: none; outline: none; font-family: 'Inter', sans-serif;
            font-size: 16px; background: transparent; resize: none; max-height: 120px;
            min-height: 24px; line-height: 24px; color: #ececec;
            -webkit-appearance: none; appearance: none;
        }
        #chat-input::placeholder { color: #777; }
        #send-btn {
            background: #00a896; color: white; border: none; border-radius: 50%;
            width: 38px; height: 38px; min-width: 38px; min-height: 38px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: opacity 0.2s;
            flex-shrink: 0; -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }
        #send-btn:hover { opacity: 0.85; }
        #send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        #image-upload-btn {
            background: rgba(255,255,255,0.08); border: none; cursor: pointer; padding: 4px;
            color: #aaa; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; width: 38px; height: 38px; min-width: 38px; min-height: 38px;
            transition: all 0.2s; flex-shrink: 0;
        }
        #image-upload-btn:hover { background: rgba(255,255,255,0.15); color: #ececec; }

        .image-preview-container {
            display: none; padding: 6px 16px; max-width: 768px; margin: 0 auto 4px auto;
        }
        .image-preview-container.active { display: flex; align-items: center; gap: 8px; }
        .image-preview-container img {
            max-width: 80px; max-height: 60px; border-radius: 8px; border: 1px solid #444; object-fit: cover;
        }
        .image-preview-remove {
            background: #ef4444; color: white; border: none; border-radius: 50%;
            width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; line-height: 1;
        }
        .user-image-bubble { max-width: 200px; border-radius: 12px; margin-bottom: 6px; display: block; }

        .typing-indicator { display: flex; gap: 4px; padding: 8px 0; }
        .typing-dot { width: 8px; height: 8px; background: #00a896; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        .welcome-text { text-align: center; padding: 30px 16px; }
        .welcome-text p { color: #888; font-size: 15px; }
        .suggestion-chips { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 16px; }
        .chip {
            padding: 8px 14px; background: #2f2f2f; border: 1px solid #444; border-radius: 20px;
            color: #d1d1d1; cursor: pointer; font-size: 13px; transition: all 0.2s;
            font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }
        .chip:hover { background: #00a896; color: white; border-color: #00a896; }

        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
        .no-convos { text-align: center; padding: 20px 10px; color: #666; font-size: 13px; }

        .md-content { white-space: normal; }
        .md-content p { margin: 0 0 8px 0; }
        .md-content p:last-child { margin-bottom: 0; }
        .md-content h2 { font-size: 1.3em; font-weight: 700; margin: 12px 0 6px 0; color: #ececec; }
        .md-content h3 { font-size: 1.15em; font-weight: 600; margin: 10px 0 4px 0; color: #ececec; }
        .md-content h4 { font-size: 1.05em; font-weight: 600; margin: 8px 0 4px 0; color: #ececec; }
        .md-content strong { font-weight: 700; color: #ececec; }
        .md-content em { font-style: italic; }
        .md-content a { color: #00a896; text-decoration: underline; }
        .md-content ul, .md-content ol { margin: 6px 0 6px 20px; padding: 0; }
        .md-content li { margin-bottom: 3px; }
        .md-content code:not(.code-block-code) {
            background: rgba(255,255,255,0.08); padding: 1px 5px; border-radius: 4px;
            font-family: 'Courier New', Courier, monospace; font-size: 0.9em; color: #f97583;
        }
        .md-content .code-block-wrapper {
            position: relative; background: #0d0d0d; border-radius: 8px; margin: 8px 0;
            overflow: hidden; border: 1px solid #333;
        }
        .md-content .code-block-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; background: #1a1a1a; font-size: 12px; color: #888;
        }
        .md-content .code-copy-btn {
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15);
            color: #aaa; font-size: 12px; padding: 3px 12px; border-radius: 4px;
            cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.2s;
        }
        .md-content .code-copy-btn:hover { background: rgba(255,255,255,0.15); color: white; }
        .md-content .code-copy-btn.copied { background: #27ae60; color: white; border-color: #27ae60; }
        .md-content .code-block-code {
            display: block; padding: 12px; overflow-x: auto; color: #e0e0e0;
            font-family: 'Courier New', Courier, monospace; font-size: 13px; line-height: 1.5;
            white-space: pre; margin: 0;
        }

        .sources-section {
            margin-top: 12px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.08);
        }
        .sources-label {
            display: flex; align-items: center; gap: 6px; font-size: 12px; color: #888;
            margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .sources-label svg { width: 14px; height: 14px; }
        .sources-list { display: flex; flex-wrap: wrap; gap: 6px; }
        .source-link {
            display: inline-flex; align-items: center; gap: 4px;
            font-size: 12px; color: #00a896; background: rgba(0,168,150,0.1);
            padding: 3px 10px; border-radius: 12px; text-decoration: none;
            transition: background 0.2s; max-width: 280px; overflow: hidden;
            text-overflow: ellipsis; white-space: nowrap;
        }
        .source-link:hover { background: rgba(0,168,150,0.2); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: 0; top: 0; z-index: 100; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .sidebar-overlay.open { display: block; }
            .menu-toggle { display: block; }
            .header-bar { padding: 8px 10px; gap: 6px; }
            .brand-name .brand-dzeck, .brand-name .brand-ai { font-size: 18px; }
            .brand-name .brand-api { font-size: 9px; }
            .model-badge { font-size: 9px; }
            .nav-links a { font-size: 11px; padding: 3px 5px; }
            .nav-links { gap: 2px; }
            .message { padding: 14px 10px; }
            .message-content { font-size: 15px; }
            .message-inner { gap: 10px; }
            .copy-btn { opacity: 1; }
            #chat-input { font-size: 16px; }
            .input-area {
                padding: 8px 10px;
                padding-bottom: max(12px, env(safe-area-inset-bottom, 12px));
            }
            #image-upload-btn {
                width: 44px; height: 44px; min-width: 44px; min-height: 44px;
                background: rgba(0,168,150,0.15); color: #00a896;
            }
            #image-upload-btn:hover, #image-upload-btn:active { background: rgba(0,168,150,0.25); }
        }

        @media (max-width: 400px) {
            .header-bar { padding: 6px 8px; gap: 4px; }
            .header-bar img.logo { width: 28px; height: 28px; }
            .brand-name .brand-dzeck, .brand-name .brand-ai { font-size: 16px; }
            .brand-name .brand-api { font-size: 8px; }
            .model-badge { font-size: 8px; padding: 1px 4px; }
            .nav-links a { font-size: 10px; padding: 2px 4px; }
            .message-content { font-size: 14px; }
            .message { padding: 10px 8px; }
            .chip { padding: 6px 10px; font-size: 11px; }
            .welcome-text p { font-size: 13px; }
            .input-wrapper { padding: 6px 6px 6px 12px; }
            #send-btn { width: 34px; height: 34px; min-width: 34px; min-height: 34px; }
            #image-upload-btn { width: 40px; height: 40px; min-width: 40px; min-height: 40px; }
        }

        @media (max-width: 320px) {
            .header-bar img.logo { width: 24px; height: 24px; }
            .brand-name .brand-dzeck, .brand-name .brand-ai { font-size: 14px; }
            .nav-links a { font-size: 9px; padding: 2px 3px; }
            .model-badge { display: none; }
            .message-content { font-size: 13px; }
            .chip { font-size: 10px; padding: 5px 8px; }
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="createNewChat()">+ New Chat</button>
        </div>
        <div class="convo-list" id="convo-list">
            <div class="no-convos" id="no-convos">Belum ada percakapan</div>
        </div>
        <div class="sidebar-footer">
            <button class="delete-all-btn" onclick="deleteAllConversations()">Hapus Semua Chat</button>
        </div>
    </aside>

    <div class="main-area">
        <div class="header-bar">
            <button class="menu-toggle" onclick="toggleSidebar()">&#9776;</button>
            <img class="logo" src="{{ url_for('static', filename='img/favicon(Nicoladipa).png') }}" alt="Logo">
            <div class="brand-name">
                <span class="brand-api">API</span>
                <span class="brand-dzeck">Dzeck</span>
                <span class="brand-ai">Ai</span>
            </div>
            <span class="model-badge" id="model-badge">loading...</span>
            <div class="nav-links">
                {% if gui_enabled %}
                <a href="/settings">Settings</a>
                {% endif %}
                <a href="/models">Models</a>
                {% if username %}
                <span style="color:#00a896;font-weight:500;">{{ username }}</span>
                <a href="/logout">Logout</a>
                {% else %}
                <a href="/login">Login</a>
                {% endif %}
            </div>
        </div>

        <div class="chat-area">
            <div class="messages" id="messages">
                <div id="welcome" class="welcome-text">
                    <div class="brand-name" style="justify-content:center;">
                        <span class="brand-api">API</span>
                        <span class="brand-dzeck" style="font-size:28px;">Dzeck</span>
                        <span class="brand-ai" style="font-size:28px;">Ai</span>
                    </div>
                    <p style="margin-top:8px;">Akses gratis ke berbagai model AI. Ketik pertanyaan di bawah untuk mulai.</p>
                    <div class="suggestion-chips">
                        <button class="chip" onclick="askQuestion('Explain quantum computing simply')">Quantum Computing</button>
                        <button class="chip" onclick="askQuestion('Write a Python hello world')">Python Code</button>
                        <button class="chip" onclick="askQuestion('What is machine learning?')">Machine Learning</button>
                        <button class="chip" onclick="askQuestion('Tell me a fun fact')">Fun Fact</button>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="image-preview-container" id="image-preview-container">
                    <img id="image-preview-img" src="" alt="Preview">
                    <button class="image-preview-remove" id="image-preview-remove" onclick="removeSelectedImage()" title="Remove image">&times;</button>
                </div>
                <div class="input-wrapper">
                    <button id="image-upload-btn" onclick="document.getElementById('image-file-input').click()" title="Attach image">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </button>
                    <input type="file" id="image-file-input" accept="image/*" style="display:none;" onchange="handleImageSelect(event)">
                    <textarea id="chat-input" rows="1" placeholder="Ketik pertanyaan..." onkeydown="handleKeyDown(event)"></textarea>
                    <button id="send-btn" onclick="sendMessage()" title="Send">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const keyword = "{{ keyword }}";
        const messagesDiv = document.getElementById('messages');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const modelBadge = document.getElementById('model-badge');
        const convoList = document.getElementById('convo-list');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const noConvos = document.getElementById('no-convos');
        const imageFileInput = document.getElementById('image-file-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreviewImg = document.getElementById('image-preview-img');
        let isLoading = false;
        let currentConvoId = null;
        let conversationMessages = [];
        let selectedImageBase64 = null;

        if (typeof marked !== 'undefined') {
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        try { return hljs.highlight(code, {language: lang}).value; } catch(e) {}
                    }
                    try { return hljs.highlightAuto(code).value; } catch(e) {}
                    return code;
                },
                breaks: true,
                gfm: true
            });
        }

        const botAvatarSVG = '<svg viewBox="0 0 24 24" fill="none" stroke="#00a896" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a4 4 0 0 1 4 4v1H8V6a4 4 0 0 1 4-4z"/><rect x="3" y="7" width="18" height="13" rx="3"/><circle cx="8.5" cy="13.5" r="1.5" fill="#00a896" stroke="none"/><circle cx="15.5" cy="13.5" r="1.5" fill="#00a896" stroke="none"/><path d="M9 17h6"/></svg>';
        const userAvatarSVG = '<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';

        function toggleSidebar() {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('open');
        }

        function timeAgo(ts) {
            const diff = (Date.now() / 1000) - ts;
            if (diff < 60) return 'baru saja';
            if (diff < 3600) return Math.floor(diff / 60) + ' mnt';
            if (diff < 86400) return Math.floor(diff / 3600) + ' jam';
            if (diff < 604800) return Math.floor(diff / 86400) + ' hari';
            return new Date(ts * 1000).toLocaleDateString('id-ID');
        }

        async function loadConversations() {
            try {
                const res = await fetch('/api/conversations');
                if (res.ok) {
                    const data = await res.json();
                    renderConvoList(data.conversations || []);
                }
            } catch(e) {
                console.error('Failed to load conversations:', e);
            }
        }

        function renderConvoList(convos) {
            const existing = convoList.querySelectorAll('.convo-item');
            existing.forEach(el => el.remove());

            if (convos.length === 0) {
                noConvos.style.display = 'block';
                return;
            }
            noConvos.style.display = 'none';

            for (const c of convos) {
                const div = document.createElement('div');
                div.className = 'convo-item' + (c.id === currentConvoId ? ' active' : '');
                div.dataset.id = c.id;
                div.onclick = (e) => { if (!e.target.classList.contains('convo-delete')) loadConversation(c.id); };

                const titleSpan = document.createElement('span');
                titleSpan.className = 'convo-title';
                titleSpan.textContent = c.title || 'New Chat';
                div.appendChild(titleSpan);

                const timeSpan = document.createElement('span');
                timeSpan.className = 'convo-time';
                timeSpan.textContent = timeAgo(c.updated_at);
                div.appendChild(timeSpan);

                const delBtn = document.createElement('button');
                delBtn.className = 'convo-delete';
                delBtn.innerHTML = '&times;';
                delBtn.onclick = (e) => { e.stopPropagation(); deleteConversation(c.id); };
                div.appendChild(delBtn);

                convoList.appendChild(div);
            }
        }

        async function createNewChat() {
            try {
                const res = await fetch('/api/conversations', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title: 'New Chat'})
                });
                if (res.ok) {
                    const convo = await res.json();
                    currentConvoId = convo.id;
                    conversationMessages = [];
                    showWelcome();
                    await loadConversations();
                    if (window.innerWidth < 768) toggleSidebar();
                }
            } catch(e) {
                console.error('Failed to create conversation:', e);
            }
        }

        async function loadConversation(convoId) {
            try {
                const res = await fetch('/api/conversations/' + convoId);
                if (res.ok) {
                    const convo = await res.json();
                    currentConvoId = convo.id;
                    let msgs = convo.messages;
                    if (typeof msgs === 'string') {
                        try { msgs = JSON.parse(msgs); } catch(e) { msgs = []; }
                    }
                    conversationMessages = msgs || [];
                    messagesDiv.innerHTML = '';
                    if (conversationMessages.length === 0) {
                        showWelcome();
                    } else {
                        for (const msg of conversationMessages) {
                            addMessageUI(msg.content, msg.role === 'user', false, msg.image || null);
                        }
                    }
                    document.querySelectorAll('.convo-item').forEach(el => {
                        el.classList.toggle('active', el.dataset.id === convoId);
                    });
                    if (window.innerWidth < 768) toggleSidebar();
                }
            } catch(e) {
                console.error('Failed to load conversation:', e);
            }
        }

        async function saveCurrentConvo() {
            if (!currentConvoId) return;
            let title = undefined;
            if (conversationMessages.length > 0) {
                const firstUser = conversationMessages.find(m => m.role === 'user');
                if (firstUser) {
                    title = firstUser.content.substring(0, 30);
                    if (firstUser.content.length > 30) title += '...';
                }
            }
            try {
                const saveMsgs = conversationMessages.map(m => {
                    const clean = {role: m.role, content: m.content, timestamp: m.timestamp};
                    if (m.image) clean.hasImage = true;
                    return clean;
                });
                await fetch('/api/conversations/' + currentConvoId, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({messages: saveMsgs, title: title})
                });
                await loadConversations();
            } catch(e) {}
        }

        async function deleteConversation(convoId) {
            try {
                await fetch('/api/conversations/' + convoId, {method: 'DELETE'});
                if (currentConvoId === convoId) {
                    currentConvoId = null;
                    conversationMessages = [];
                    showWelcome();
                }
                await loadConversations();
            } catch(e) {}
        }

        async function deleteAllConversations() {
            if (!confirm('Hapus semua percakapan? Ini tidak bisa dibatalkan.')) return;
            try {
                await fetch('/api/conversations/all', {method: 'DELETE'});
                currentConvoId = null;
                conversationMessages = [];
                showWelcome();
                await loadConversations();
            } catch(e) {}
        }

        function showWelcome() {
            messagesDiv.innerHTML = `
                <div id="welcome" class="welcome-text">
                    <div class="brand-name" style="justify-content:center;">
                        <span class="brand-api">API</span>
                        <span class="brand-dzeck" style="font-size:28px;">Dzeck</span>
                        <span class="brand-ai" style="font-size:28px;">Ai</span>
                    </div>
                    <p style="margin-top:8px;">Akses gratis ke berbagai model AI. Ketik pertanyaan di bawah untuk mulai.</p>
                    <div class="suggestion-chips">
                        <button class="chip" onclick="askQuestion('Explain quantum computing simply')">Quantum Computing</button>
                        <button class="chip" onclick="askQuestion('Write a Python hello world')">Python Code</button>
                        <button class="chip" onclick="askQuestion('What is machine learning?')">Machine Learning</button>
                        <button class="chip" onclick="askQuestion('Tell me a fun fact')">Fun Fact</button>
                    </div>
                </div>`;
        }

        async function loadChatSettings() {
            try {
                const res = await fetch('/api/chat-settings');
                if (res.ok) {
                    const data = await res.json();
                    const catColor = data.category_color || '#034953';
                    const catLabel = data.category_label || 'General';
                    const modelName = data.model_name || data.model;
                    modelBadge.innerHTML = '<span style="background:' + catColor + ';color:white;padding:1px 5px;border-radius:6px;font-size:9px;margin-right:4px;">' + catLabel + '</span>' + modelName;
                    modelBadge.style.background = 'rgba(0,168,150,0.1)';
                }
            } catch(e) {
                modelBadge.textContent = '';
            }
        }

        (async function init() {
            loadChatSettings();
            await loadConversations();
        })();

        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        chatInput.addEventListener('focus', function() {
            setTimeout(() => {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                const inputArea = document.querySelector('.input-area');
                if (inputArea) {
                    inputArea.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }
            }, 300);
        });

        if (window.visualViewport) {
            let pendingUpdate = false;
            function updateViewportHeight() {
                if (pendingUpdate) return;
                pendingUpdate = true;
                requestAnimationFrame(() => {
                    const vh = window.visualViewport.height;
                    const offset = window.visualViewport.offsetTop;
                    document.documentElement.style.height = vh + 'px';
                    document.body.style.height = vh + 'px';
                    document.querySelector('.main-area').style.height = vh + 'px';
                    window.scrollTo(0, offset);
                    pendingUpdate = false;
                });
            }
            window.visualViewport.addEventListener('resize', updateViewportHeight);
            window.visualViewport.addEventListener('scroll', updateViewportHeight);
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function askQuestion(text) {
            chatInput.value = text;
            sendMessage();
        }

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedImageBase64 = e.target.result;
                imagePreviewImg.src = selectedImageBase64;
                imagePreviewContainer.classList.add('active');
            };
            reader.readAsDataURL(file);
        }

        function removeSelectedImage() {
            selectedImageBase64 = null;
            imagePreviewImg.src = '';
            imagePreviewContainer.classList.remove('active');
            imageFileInput.value = '';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderMarkdown(text) {
            if (typeof marked !== 'undefined' && marked.parse) {
                try { return marked.parse(text); } catch(e) {}
            }
            return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
        }

        function addCodeCopyButtons(container) {
            const pres = container.querySelectorAll('pre');
            pres.forEach(function(pre) {
                if (pre.parentElement && pre.parentElement.classList.contains('code-block-wrapper')) return;
                const code = pre.querySelector('code');
                let lang = '';
                if (code) {
                    const cls = code.className || '';
                    const m = cls.match(/language-(\w+)/);
                    if (m) lang = m[1];
                    try { hljs.highlightElement(code); } catch(e) {}
                }
                const wrapper = document.createElement('div');
                wrapper.className = 'code-block-wrapper';
                const header = document.createElement('div');
                header.className = 'code-block-header';
                header.innerHTML = '<span>' + (lang || 'code') + '</span>';
                const copyBtn = document.createElement('button');
                copyBtn.className = 'code-copy-btn';
                copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy';
                copyBtn.onclick = function(ev) {
                    ev.stopPropagation();
                    const codeText = pre.textContent;
                    navigator.clipboard.writeText(codeText).then(function() {
                        copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Copied!';
                        copyBtn.classList.add('copied');
                        setTimeout(function() {
                            copyBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy';
                            copyBtn.classList.remove('copied');
                        }, 2000);
                    });
                };
                header.appendChild(copyBtn);
                pre.parentNode.insertBefore(wrapper, pre);
                wrapper.appendChild(header);
                wrapper.appendChild(pre);
            });
        }

        function extractSourceUrls(text) {
            const urlRegex = /https?:\/\/[^\s\)\]<>"']+/g;
            const matches = text.match(urlRegex);
            if (!matches) return [];
            const unique = [...new Set(matches)];
            return unique.slice(0, 5);
        }

        function renderSourcesSection(urls) {
            if (!urls || urls.length === 0) return '';
            let html = '<div class="sources-section"><div class="sources-label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>Sources</div><div class="sources-list">';
            for (const url of urls) {
                let label = url;
                try {
                    const u = new URL(url);
                    label = u.hostname.replace('www.', '');
                } catch(e) {}
                html += '<a class="source-link" href="' + url + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(label) + '</a>';
            }
            html += '</div></div>';
            return html;
        }

        function addMessageUI(text, isUser, useMarkdown, imageData) {
            const welcome = document.getElementById('welcome');
            if (welcome) welcome.style.display = 'none';

            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ' + (isUser ? 'message-user' : 'message-ai');

            const innerDiv = document.createElement('div');
            innerDiv.className = 'message-inner';

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.innerHTML = isUser ? userAvatarSVG : botAvatarSVG;
            innerDiv.appendChild(avatarDiv);

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (isUser && imageData) {
                const img = document.createElement('img');
                img.src = imageData;
                img.className = 'user-image-bubble';
                img.alt = 'Uploaded image';
                contentDiv.appendChild(img);
            }

            if (isUser) {
                const textSpan = document.createElement('span');
                textSpan.textContent = text;
                contentDiv.appendChild(textSpan);
            } else {
                const mdDiv = document.createElement('div');
                mdDiv.className = 'md-content';
                if (text) {
                    mdDiv.innerHTML = renderMarkdown(text);
                    addCodeCopyButtons(mdDiv);
                } else {
                    mdDiv.innerHTML = '';
                }
                mdDiv.dataset.rawText = text || '';
                contentDiv.appendChild(mdDiv);

                const urls = extractSourceUrls(text || '');
                if (urls.length > 0) {
                    const sourcesDiv = document.createElement('div');
                    sourcesDiv.innerHTML = renderSourcesSection(urls);
                    contentDiv.appendChild(sourcesDiv.firstElementChild);
                }

                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'Copy';
                copyBtn.onclick = function(e) {
                    e.stopPropagation();
                    const raw = mdDiv.dataset.rawText || mdDiv.textContent;
                    navigator.clipboard.writeText(raw).then(function() {
                        copyBtn.textContent = 'Copied!';
                        copyBtn.classList.add('copied');
                        setTimeout(function() {
                            copyBtn.textContent = 'Copy';
                            copyBtn.classList.remove('copied');
                        }, 2000);
                    });
                };
                contentDiv.appendChild(copyBtn);
            }

            innerDiv.appendChild(contentDiv);
            msgDiv.appendChild(innerDiv);
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return contentDiv;
        }

        function showTyping() {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message message-ai';
            msgDiv.id = 'typing';
            const innerDiv = document.createElement('div');
            innerDiv.className = 'message-inner';
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.innerHTML = botAvatarSVG;
            innerDiv.appendChild(avatarDiv);
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
            innerDiv.appendChild(contentDiv);
            msgDiv.appendChild(innerDiv);
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function removeTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        function buildContextMessage(newMessage) {
            if (conversationMessages.length === 0) return newMessage;
            let context = "[CONVERSATION HISTORY]\n";
            const historySlice = conversationMessages;
            for (const msg of historySlice) {
                let msgText = msg.content || '';
                if (msg.image) {
                    msgText += ' [Image attached]';
                }
                if (msg.role === "user") context += "User: " + msgText + "\n";
                else if (msg.role === "assistant") context += "Assistant: " + msgText + "\n";
            }
            context += "[END HISTORY]\n\nUser: " + newMessage;
            return context;
        }

        async function sendMessage() {
            if (isLoading) return;
            const text = chatInput.value.trim();
            if (!text && !selectedImageBase64) return;

            if (!currentConvoId) {
                await createNewChat();
            }

            isLoading = true;
            sendBtn.disabled = true;
            chatInput.value = '';
            chatInput.style.height = 'auto';

            const currentImage = selectedImageBase64;
            removeSelectedImage();

            addMessageUI(text, true, false, currentImage);
            const imageThumb = currentImage ? currentImage.substring(0, 100) + '...[truncated]' : undefined;
            conversationMessages.push({role: 'user', content: text, image: currentImage || undefined, imageThumb: imageThumb, timestamp: Date.now()});
            showTyping();

            const contextMessage = buildContextMessage(text);

            try {
                const body = {text: contextMessage};
                if (currentImage) {
                    body.image = currentImage;
                }

                const res = await fetch('/stream', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });
                if (!res.ok) throw new Error('Server error');

                removeTyping();
                const contentArea = addMessageUI('', false);
                const mdContent = contentArea.querySelector('.md-content');

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';
                let buffer = '';
                let lastRenderTime = 0;
                let renderPending = false;

                function throttledRender() {
                    if (mdContent) {
                        mdContent.innerHTML = renderMarkdown(fullText);
                        mdContent.dataset.rawText = fullText;
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    }
                    renderPending = false;
                    lastRenderTime = Date.now();
                }

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const payload = line.slice(6);
                            if (payload === '[DONE]') continue;
                            try {
                                const chunk = JSON.parse(payload);
                                fullText += chunk;
                                const now = Date.now();
                                if (now - lastRenderTime >= 100) {
                                    throttledRender();
                                } else if (!renderPending) {
                                    renderPending = true;
                                    setTimeout(throttledRender, 100 - (now - lastRenderTime));
                                }
                            } catch (e) {}
                        }
                    }
                }

                throttledRender();
                addCodeCopyButtons(mdContent);

                const urls = extractSourceUrls(fullText);
                if (urls.length > 0) {
                    const existing = contentArea.querySelector('.sources-section');
                    if (existing) existing.remove();
                    const sourcesDiv = document.createElement('div');
                    sourcesDiv.innerHTML = renderSourcesSection(urls);
                    contentArea.appendChild(sourcesDiv.firstElementChild);
                }

                conversationMessages.push({role: 'assistant', content: fullText, timestamp: Date.now()});
                await saveCurrentConvo();
            } catch (err) {
                removeTyping();
                addMessageUI('Error: Could not get response. Please try again.', false);
            }

            isLoading = false;
            sendBtn.disabled = false;
            chatInput.focus();
        }
    </script>
</body>
</html>
